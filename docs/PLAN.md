# EnterSandBox 実装計画

> **ドキュメントバージョン:** 1.0  
> **最終更新:** 2025-01-11  
> **参照:** [SPEC.md](./SPEC.md), [RESEARCH.md](./RESEARCH.md)

---

## 凡例

| ステータス | 意味 |
| --- | --- |
| `[ ]` | 未着手 |
| `[/]` | 進行中 |
| `[x]` | 完了 |
| `[!]` | ブロック中（依存タスク待ち or 課題あり） |

**依存関係の表記:** `depends: [タスクID]` — 当該タスクを開始する前に完了必須のタスク

---

## Phase 1: The Nano-Sandbox (MVP)

**目標:** 「世界最速・最も手軽なPythonサンドボックス」のリリース

### 1.1 プロジェクト基盤

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P1-001 | Rustプロジェクト初期化 | `cargo new agentbox-core --lib` でライブラリクレート作成。Cargo.toml に wasmtime, rustpython 依存を追加 | `[ ]` | - |
| P1-002 | Python SDK スケルトン作成 | `agentbox/` ディレクトリ構成、`pyproject.toml` (maturin)、`__init__.py` 作成 | `[ ]` | - |
| P1-003 | CI パイプライン構築 | GitHub Actions で Rust build + test、Python lint + test を実行 | `[ ]` | P1-001, P1-002 |
| P1-004 | 開発環境ドキュメント | `CONTRIBUTING.md` に開発セットアップ手順を記載 | `[ ]` | P1-001 |

### 1.2 Wasmtime ランタイム統合

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P1-010 | Wasmtime Engine 初期化 | `wasmtime::Engine` と `wasmtime::Store` の初期化ロジック実装 | `[ ]` | P1-001 |
| P1-011 | WASI 設定 | `wasmtime_wasi` で最小限の WASI 環境構築（stdin/stdout/stderr のみ、ファイルシステムなし） | `[ ]` | P1-010 |
| P1-012 | リソース制限実装 | メモリ上限（`wasmtime::ResourceLimiter`）、実行時間タイムアウト（epoch interruption）実装 | `[ ]` | P1-010 |
| P1-013 | Wasmtime 単体テスト | Engine 初期化、リソース制限が正しく動作することを検証 | `[ ]` | P1-012 |

### 1.3 RustPython 統合

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P1-020 | RustPython WASM ビルド | RustPython を `wasm32-wasip1` でビルド。**標準ライブラリ(Lib/)を同梱または仮想FSへマウントする仕組みを構築** | `[ ]` | P1-001 |
| P1-021 | Python コード実行パイプライン | ユーザーコードを RustPython wasm モジュールに渡し、stdout/stderr をキャプチャ | `[ ]` | P1-010, P1-020 |
| P1-022 | 標準ライブラリ確認 | `json`, `re`, `datetime`, `collections` 等の標準ライブラリがロード可能か検証・修正 | `[ ]` | P1-021 |
| P1-023 | エラーハンドリング | Python 例外 → Rust Result 変換、ユーザーフレンドリーなエラーメッセージ生成 | `[ ]` | P1-021 |

### 1.4 メモリ内仮想ファイルシステム

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P1-030 | VirtualFS 設計 | インメモリ VFS のデータ構造設計（inode テーブル、ディレクトリツリー） | `[ ]` | P1-001 |
| P1-031 | VirtualFS 実装 | `open`, `read`, `write`, `mkdir`, `stat` 等の基本操作実装 | `[ ]` | P1-030 |
| P1-032 | WASI との統合 | `wasmtime_wasi::WasiCtxBuilder` に VirtualFS をマウント | `[ ]` | P1-011, P1-031 |
| P1-033 | VirtualFS テスト | ファイル作成・読み書き・削除のユニットテスト | `[ ]` | P1-032 |

### 1.5 Python SDK (agentbox)

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P1-040 | Rust → Python バインディング | PyO3/Maturin で `Sandbox` クラスを Python に公開 | `[ ]` | P1-021, P1-032 |
| P1-041 | `Sandbox.run()` API | コード文字列を受け取り `SandboxResult(stdout, stderr, exit_code)` を返す | `[ ]` | P1-040 |
| P1-042 | `SandboxConfig` 実装 | `timeout_ms`, `memory_limit_mb`, `allowed_modules` 設定項目 | `[ ]` | P1-041 |
| P1-043 | 型ヒント (`.pyi`) | Python の型チェック対応のためスタブファイル作成 | `[ ]` | P1-041 |
| P1-044 | SDK ドキュメント | README.md に使用例、API リファレンス記載 | `[ ]` | P1-042 |

### 1.6 テスト & ベンチマーク (Phase 1)

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P1-050 | ユニットテスト整備 | 各 Rust モジュールに `#[cfg(test)]` でテスト追加。カバレッジ 80% 目標 | `[ ]` | P1-023, P1-033 |
| P1-051 | Python 統合テスト | `pytest` で SDK の E2E テスト（正常系・異常系 20ケース以上） | `[ ]` | P1-042 |
| P1-052 | 起動時間ベンチマーク | `criterion` で cold start 計測。目標: < 10ms | `[ ]` | P1-041 |
| P1-053 | メモリベンチマーク | 実行中のピークメモリ使用量計測 | `[ ]` | P1-041 |
| P1-054 | CI ベンチマーク統合 | PR ごとに性能リグレッションを検出する仕組み | `[ ]` | P1-003, P1-052 |

### 1.7 リリース準備

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P1-060 | PyPI パッケージング | maturin で wheel ビルド、`pyproject.toml` メタデータ整備 | `[ ]` | P1-043 |
| P1-061 | リリース CI | GitHub Release → PyPI 自動公開ワークフロー | `[ ]` | P1-060 |
| P1-062 | バージョニング戦略 | SemVer 運用ルール、CHANGELOG.md 作成 | `[ ]` | P1-060 |

---

## Phase 2: The Heavy-Sandbox & Routing

**目標:** データサイエンス対応とハイブリッド実行の実現

> [!NOTE]
> Phase 2 は Phase 1 のすべてのタスク完了後に開始

### 2.1 Firecracker 統合基盤

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P2-001 | Firecracker 評価 & 開発環境 | Firecracker vs libkrun 比較。**macOS/Windows での Firecracker 開発環境（Dev Container, Vagrant等）の確立** | `[ ]` | Phase 1 完了 |
| P2-002 | VM イメージ作成 | Python + 基本ライブラリを含む rootfs イメージ作成（Alpine Linux ベース） | `[ ]` | P2-001 |
| P2-003 | VM プール管理設計 | プール戦略設計（ウォームインスタンス数、スケール閾値） | `[ ]` | P2-001 |
| P2-004 | VM プール実装 | ウォーム VM プールの生成・取得・返却ロジック実装 | `[ ]` | P2-003 |
| P2-005 | スナップショット起動 | 起動済み VM のメモリスナップショットからの高速復元実装 | `[ ]` | P2-002, P2-004 |

### 2.2 アダプティブ・ランタイム・ルーター

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P2-010 | コード解析エンジン | Python AST を解析し、import 文から依存ライブラリを抽出 | `[ ]` | Phase 1 完了 |
| P2-011 | ルーティングルール定義 | Tier 1/2 切り分けルール（NumPy/Pandas/Matplotlib → Tier 2 等）を設定ファイル化 | `[ ]` | P2-010 |
| P2-012 | Router 実装 | コード解析結果とルールに基づき適切なランタイムを選択・ディスパッチ | `[ ]` | P2-011, P2-004 |
| P2-013 | フォールバック機構 | Tier 1 で実行失敗時に自動的に Tier 2 へフォールバック | `[ ]` | P2-012 |

### 2.3 Tier 2 実行エンジン

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P2-020 | VM 内コード実行 | コードを VM に転送し、Python インタプリタで実行、結果を取得 | `[ ]` | P2-005 |
| P2-021 | `pip install` サポート | 実行時に必要なパッケージを VM 内でインストール（キャッシュ機構付き） | `[ ]` | P2-020 |
| P2-022 | ファイル I/O | ホスト ↔ VM 間のファイル転送 API 実装 | `[ ]` | P2-020 |
| P2-023 | セッション永続化 | セッション間で VM 状態を保持するオプション実装 | `[ ]` | P2-020 |

### 2.4 SDK 拡張

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P2-030 | `SandboxConfig.runtime` | `"auto"`, `"nano"`, `"heavy"` の選択オプション追加 | `[ ]` | P2-012 |
| P2-031 | `SandboxConfig.packages` | 必要なパッケージリスト指定オプション | `[ ]` | P2-021 |
| P2-032 | ファイルアップロード API | `sandbox.upload_file(local_path, remote_path)` 実装 | `[ ]` | P2-022 |
| P2-033 | ファイルダウンロード API | `sandbox.download_file(remote_path)` 実装 | `[ ]` | P2-022 |

### 2.5 テスト & ベンチマーク (Phase 2)

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P2-040 | ルーター単体テスト | 各種 import パターンでの正しいルーティング判定を検証 | `[ ]` | P2-012 |
| P2-041 | VM 統合テスト | Pandas/NumPy を使用するコードの E2E テスト | `[ ]` | P2-021 |
| P2-042 | 起動時間ベンチマーク (Tier 2) | VM + スナップショット復元の時間計測。目標: < 150ms | `[ ]` | P2-005 |
| P2-043 | 負荷テスト | 同時実行 100 リクエストでのスループット・レイテンシ計測 | `[ ]` | P2-023 |

---

## Phase 3: Governance & Security

**目標:** エンタープライズガバナンス機能の実装

> [!NOTE]
> Phase 3 は Phase 2 のコア機能（P2-001〜P2-023）完了後に開始可能

### 3.1 ネットワーク DLP サイドカー

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P3-001 | サイドカー技術選定 | Envoy vs Mitmproxy 評価、パフォーマンス・機能比較 | `[ ]` | Phase 2 コア完了 |
| P3-002 | 透過プロキシ構築 | VM からの全アウトバウンド通信をインターセプト | `[ ]` | P3-001 |
| P3-003 | ドメインホワイトリスト | 許可ドメインリストによるフィルタリング実装 | `[ ]` | P3-002 |
| P3-004 | PII スキャニング実装 | 正規表現パターンによる機密情報検出（クレジットカード、APIキー等） | `[ ]` | P3-002 |
| P3-005 | Intent-based ファイアウォール | タスクコンテキストに基づく動的許可ルール | `[ ]` | P3-003 |

### 3.2 監査ログ

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P3-010 | ログスキーマ設計 | 監査ログの JSON スキーマ定義（タイムスタンプ、リクエスト内容、判定結果） | `[ ]` | P3-002 |
| P3-011 | ログ収集実装 | サイドカーからのログ出力、ストレージへの永続化 | `[ ]` | P3-010 |
| P3-012 | ログ検索 API | 時間範囲・キーワードでの監査ログ検索 | `[ ]` | P3-011 |
| P3-013 | コンプライアンスレポート | 定期レポート生成機能（日次/週次サマリー） | `[ ]` | P3-011 |

### 3.3 MCP ネイティブホスティング

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P3-020 | MCP プロトコル調査 | Anthropic MCP 仕様の詳細調査、実装要件整理 | `[ ]` | Phase 2 コア完了 |
| P3-021 | MCP サーバーランタイム | サンドボックス内での MCP サーバー起動・管理 | `[ ]` | P3-020 |
| P3-022 | ツール登録 API | エージェントが利用可能なツールの登録・管理 | `[ ]` | P3-021 |
| P3-023 | DLP 統合 | MCP ツール呼び出しに対する DLP ポリシー適用 | `[ ]` | P3-004, P3-022 |

### 3.4 テスト (Phase 3)

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P3-030 | DLP 単体テスト | 各種 PII パターン検出の正確性検証 | `[ ]` | P3-004 |
| P3-031 | ファイアウォール E2E テスト | 禁止ドメインへのアクセス遮断、許可ドメインへのアクセス許可 | `[ ]` | P3-005 |
| P3-032 | 監査ログ整合性テスト | すべてのリクエストが正しくログされることを検証 | `[ ]` | P3-011 |
| P3-033 | MCP 統合テスト | ツール呼び出しの正常動作と DLP 適用を検証 | `[ ]` | P3-023 |

---

## Phase 4: Time Travel Debugging

**目標:** 究極のデバッグ体験の提供

> [!NOTE]
> Phase 4 は Phase 2 の VM 基盤が安定した後に開始可能

### 4.1 スナップショット管理

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P4-001 | 差分スナップショット設計 | メモリ/ディスク状態の効率的な差分保存方式設計 | `[ ]` | P2-005 |
| P4-002 | スナップショット取得 API | 各ステップ実行後に自動スナップショット取得 | `[ ]` | P4-001 |
| P4-003 | スナップショット復元 API | 指定ステップへの巻き戻し実装 | `[ ]` | P4-002 |
| P4-004 | ストレージ管理 | スナップショットの保存期間管理、古いデータの自動削除 | `[ ]` | P4-002 |

### 4.2 デバッグ UI

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P4-010 | Web UI 技術スタック選定 | React/Vue/Svelte 等の選定 | `[ ]` | P4-003 |
| P4-011 | タイムライン表示 | 実行ステップのタイムライン可視化 | `[ ]` | P4-010 |
| P4-012 | 状態インスペクター | 各ステップでの変数値・ファイル内容表示 | `[ ]` | P4-011 |
| P4-013 | シェルアクセス | 任意ステップでの対話シェル起動 | `[ ]` | P4-003 |

### 4.3 視覚的アーティファクト

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P4-020 | Matplotlib キャプチャ | `plt.show()` 呼び出しの自動インターセプト・画像保存 | `[ ]` | P2-020 |
| P4-021 | アーティファクトプロトコル | 画像・ファイル・テーブル等の構造化メタデータ定義 | `[ ]` | P4-020 |
| P4-022 | UI 統合 | アーティファクトの Web UI 表示 | `[ ]` | P4-012, P4-021 |

### 4.4 テスト (Phase 4)

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| P4-030 | スナップショット整合性テスト | 復元後の状態が取得時と一致することを検証 | `[ ]` | P4-003 |
| P4-031 | UI E2E テスト | Playwright でのブラウザ自動テスト | `[ ]` | P4-012 |
| P4-032 | アーティファクトキャプチャテスト | 各種グラフライブラリの出力がキャプチャされることを検証 | `[ ]` | P4-020 |

---

## CI/CD パイプライン

### 継続的インテグレーション

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| CI-001 | Rust ビルド & テスト | `cargo build`, `cargo test`, `cargo clippy` | `[ ]` | P1-003 |
| CI-002 | Python lint & テスト | `ruff`, `mypy`, `pytest` | `[ ]` | P1-003 |
| CI-003 | クロスプラットフォームビルド | Linux (x86_64, aarch64), macOS (x86_64, aarch64), Windows | `[ ]` | CI-001 |
| CI-004 | カバレッジ計測 | `cargo-llvm-cov` + `pytest-cov`、Codecov 連携 | `[ ]` | CI-001, CI-002 |
| CI-005 | ベンチマーク CI | PR ごとに `criterion` ベンチマーク実行、リグレッション検出 | `[ ]` | P1-054 |
| CI-006 | セキュリティスキャン | `cargo-audit`, `pip-audit`, Dependabot | `[ ]` | CI-001, CI-002 |

### 継続的デリバリー

| ID | タスク | 詳細 | ステータス | 依存 |
| --- | --- | --- | --- | --- |
| CD-001 | PyPI 自動リリース | tag push → PyPI 公開ワークフロー | `[ ]` | P1-061 |
| CD-002 | Crates.io リリース | Rust クレートの公開（オプション） | `[ ]` | P1-062 |
| CD-003 | Docker イメージビルド | Phase 2 以降の VM イメージ用 | `[ ]` | P2-002 |
| CD-004 | ドキュメント自動デプロイ | GitHub Pages への API ドキュメント公開 | `[ ]` | P1-044 |

---

## マイルストーンサマリー

| マイルストーン | 完了条件 | 目標日 | ステータス |
| --- | --- | --- | --- |
| **M1: MVP リリース** | Phase 1 全タスク完了、PyPI v0.1.0 公開 | TBD | `[ ]` |
| **M2: データサイエンス対応** | Phase 2 全タスク完了、Pandas/NumPy 動作確認 | TBD | `[ ]` |
| **M3: エンタープライズ対応** | Phase 3 全タスク完了、DLP 機能リリース | TBD | `[ ]` |
| **M4: デバッグ体験** | Phase 4 全タスク完了、Web UI リリース | TBD | `[ ]` |

---

## メモ・課題

> このセクションは実装中に発見した課題やメモを記録します

- (記録予定)
